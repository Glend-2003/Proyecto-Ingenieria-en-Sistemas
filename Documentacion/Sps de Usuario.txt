DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spAgregarUsuario`(IN `p_cedulaUsuario` VARCHAR(255), IN `p_nombreUsuario` VARCHAR(255), IN `p_primerApellido` VARCHAR(255), IN `p_segundoApellido` VARCHAR(255), IN `p_telefonoUsuario` VARCHAR(255), IN `p_correoUsuario` VARCHAR(255), IN `p_contraseniaUsuario` VARCHAR(255), IN `p_fechaNacimiento` DATE, IN `p_descripcionDireccion` VARCHAR(255), IN `p_codigoPostalDireccion` VARCHAR(255), IN `p_idDistrito` INT, IN `p_idRol` INT)
BEGIN
    -- Insertar la dirección en la tabla tbdireccion
    INSERT INTO tbdireccion (codigoPostalDireccion, descripcionDireccion, idDistrito)
    VALUES (p_codigoPostalDireccion, p_descripcionDireccion, p_idDistrito);

    -- Obtener el ID de la dirección insertada
    SET @idDireccion = LAST_INSERT_ID();

    -- Insertar el usuario en la tabla tbusuario con la dirección relacionada
    INSERT INTO tbusuario (cedulaUsuario, nombreUsuario, primerApellido, segundoApellido, telefonoUsuario, correoUsuario, contraseniaUsuario, fechaNacimiento, idDireccion, idRol)
    VALUES (p_cedulaUsuario, p_nombreUsuario, p_primerApellido, p_segundoApellido, p_telefonoUsuario, p_correoUsuario, p_contraseniaUsuario, p_fechaNacimiento, @idDireccion, p_idRol);
END$$
DELIMITER ;

----------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spActualizarUsuario`(IN `p_idUsuario` INT, IN `p_cedulaUsuario` VARCHAR(255), IN `p_nombreUsuario` VARCHAR(255), IN `p_primerApellido` VARCHAR(255), IN `p_segundoApellido` VARCHAR(255), IN `p_telefonoUsuario` VARCHAR(255), IN `p_correoUsuario` VARCHAR(255), IN `p_contraseniaUsuario` VARCHAR(255), IN `p_fechaNacimiento` DATE, IN `p_descripcionDireccion` VARCHAR(255), IN `p_codigoPostalDireccion` VARCHAR(255), IN `p_idDistrito` INT)
BEGIN
    -- Actualizar la información del usuario
    UPDATE tbusuario
    SET cedulaUsuario = p_cedulaUsuario,
        nombreUsuario = p_nombreUsuario,
        primerApellido = p_primerApellido,
        segundoApellido = p_segundoApellido,
        telefonoUsuario = p_telefonoUsuario,
        correoUsuario = p_correoUsuario,
        contraseniaUsuario = p_contraseniaUsuario,
        fechaNacimiento = p_fechaNacimiento
    WHERE idUsuario = p_idUsuario;

    -- Obtener la idDireccion del usuario
    SELECT idDireccion INTO @idDireccion FROM tbusuario WHERE idUsuario = p_idUsuario;

    -- Actualizar la información de la dirección relacionada
    UPDATE tbdireccion
    SET descripcionDireccion = p_descripcionDireccion,
        codigoPostalDireccion = p_codigoPostalDireccion,
        idDistrito = p_idDistrito
    WHERE idDireccion = @idDireccion;
END$$
DELIMITER ;

-------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spEliminarUsuario`(IN p_idUsuario INT)
BEGIN
    -- Obtener la idDireccion del usuario
    SELECT idDireccion INTO @idDireccion FROM tbusuario WHERE idUsuario = p_idUsuario;

    -- Eliminar el usuario
    DELETE FROM tbusuario WHERE idUsuario = p_idUsuario;

    -- Eliminar la dirección relacionada
    DELETE FROM tbdireccion WHERE idDireccion = @idDireccion;
END$$
DELIMITER ;

----------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spLeerUsuario`()
BEGIN
    SELECT 
        u.idUsuario, 
        u.cedulaUsuario, 
        u.nombreUsuario, 
        u.primerApellido, 
        u.segundoApellido, 
        u.telefonoUsuario, 
        u.correoUsuario, 
        u.contraseniaUsuario, 
        u.fechaNacimiento,
        u.idRol, -- Agrega idRol
        d.idDistrito -- Agrega idDistrito
    FROM 
        tbusuario u
    INNER JOIN 
        tbdireccion d ON u.idDireccion = d.idDireccion;
END$$
DELIMITER ;

--------------------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spBuscarUsuarioPorCorreo`(
    IN correoInput VARCHAR(255)
)
BEGIN
    -- Selecciona todos los campos del usuario basándose en el correo proporcionado
    SELECT 
        u.idUsuario, 
        u.nombreUsuario, 
        u.primerApellido, 
        u.segundoApellido, 
        u.fechaNacimiento, 
        u.cedulaUsuario, 
        u.correoUsuario, 
        u.telefonoUsuario, 
        u.contraseniaUsuario,  -- Contraseña encriptada
        u.idRol,  -- ID del Rol del Usuario
        r.nombreRol,  -- Nombre del Rol
        r.descripcionRol, -- Descripción del Rol
        u.idDireccion  -- Asegúrate de incluir esto
    FROM 
        tbusuario u
    LEFT JOIN 
        tbrol r ON u.idRol = r.idRol
    WHERE 
        u.correoUsuario = correoInput;
END$$
DELIMITER ;