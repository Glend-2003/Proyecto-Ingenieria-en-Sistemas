DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spAgregarUsuario`(
    IN `p_cedulaUsuario` VARCHAR(255), 
    IN `p_nombreUsuario` VARCHAR(255), 
    IN `p_primerApellido` VARCHAR(255), 
    IN `p_segundoApellido` VARCHAR(255), 
    IN `p_telefonoUsuario` VARCHAR(255), 
    IN `p_correoUsuario` VARCHAR(255), 
    IN `p_contraseniaUsuario` VARCHAR(255), 
    IN `p_fechaNacimiento` DATE,  
    IN `p_descripcionDireccion` VARCHAR(255), 
    IN `p_codigoPostalDireccion` VARCHAR(255), 
    IN `p_idDistrito` INT, 
    IN `p_idRol` INT
)
BEGIN
    INSERT INTO tbdireccion (codigoPostalDireccion, descripcionDireccion, idDistrito)
    VALUES (IFNULL(p_codigoPostalDireccion, NULL), p_descripcionDireccion, p_idDistrito);

    SET @idDireccion = LAST_INSERT_ID();

    INSERT INTO tbusuario (cedulaUsuario, nombreUsuario, primerApellido, segundoApellido, telefonoUsuario, correoUsuario, contraseniaUsuario, fechaNacimiento, idDireccion, idRol)
    VALUES (p_cedulaUsuario, p_nombreUsuario, p_primerApellido, p_segundoApellido, p_telefonoUsuario, p_correoUsuario, p_contraseniaUsuario, IFNULL(p_fechaNacimiento, NULL), @idDireccion, p_idRol);
END$$
DELIMITER ;

----------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spActualizarUsuario`(
    IN `p_idUsuario` INT, 
    IN `p_cedulaUsuario` VARCHAR(255), 
    IN `p_nombreUsuario` VARCHAR(255), 
    IN `p_primerApellido` VARCHAR(255), 
    IN `p_segundoApellido` VARCHAR(255), 
    IN `p_telefonoUsuario` VARCHAR(255), 
    IN `p_correoUsuario` VARCHAR(255), 
    IN `p_contraseniaUsuario` VARCHAR(255), 
    IN `p_fechaNacimiento` DATE, 
    IN `p_descripcionDireccion` VARCHAR(255), 
    IN `p_codigoPostalDireccion` VARCHAR(255), 
    IN `p_idDistrito` INT
)
BEGIN
    -- Actualizar la información del usuario solo si se proporcionan los valores, usando IFNULL para mantener los valores anteriores
    UPDATE tbusuario
    SET cedulaUsuario = IFNULL(p_cedulaUsuario, cedulaUsuario),
        nombreUsuario = IFNULL(p_nombreUsuario, nombreUsuario),
        primerApellido = IFNULL(p_primerApellido, primerApellido),
        segundoApellido = IFNULL(p_segundoApellido, segundoApellido),
        telefonoUsuario = IFNULL(p_telefonoUsuario, telefonoUsuario),
        correoUsuario = IFNULL(p_correoUsuario, correoUsuario),
        contraseniaUsuario = IFNULL(p_contraseniaUsuario, contraseniaUsuario),
        fechaNacimiento = IFNULL(p_fechaNacimiento, fechaNacimiento)
    WHERE idUsuario = p_idUsuario;

    -- Obtener el idDireccion del usuario
    SELECT idDireccion INTO @idDireccion FROM tbusuario WHERE idUsuario = p_idUsuario;

    -- Actualizar la información de la dirección relacionada, usando IFNULL para mantener los valores anteriores
    UPDATE tbdireccion
    SET descripcionDireccion = IFNULL(p_descripcionDireccion, descripcionDireccion),
        codigoPostalDireccion = IFNULL(p_codigoPostalDireccion, codigoPostalDireccion),
        idDistrito = IFNULL(p_idDistrito, idDistrito)
    WHERE idDireccion = @idDireccion;
END$$
DELIMITER ;

-------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spEliminarUsuario`(IN p_idUsuario INT, OUT p_salida VARCHAR(30))
BEGIN
		
    -- Variable de control
    DECLARE done INT DEFAULT 0;

    -- Manejador de errores para capturar excepciones SQL genéricas
    DECLARE EXIT HANDLER FOR SQLEXCEPTION 
    BEGIN
        -- Si ocurre un error SQL, se hace rollback y se asigna un mensaje genérico
        ROLLBACK;
        SET p_salida = 'Error al eliminar';
    END;

 		IF done = 0 AND NOT EXISTS (SELECT 1 FROM tbusuario WHERE idUsuario = p_idUsuario) THEN
        SET p_salida = 'El id del usuario no existe';
        SET done = 1; -- Detener flujo si hay error
    END IF;

	 IF done = 0 THEN
    -- Obtener la idDireccion del usuario
    SELECT idDireccion INTO @idDireccion FROM tbusuario WHERE idUsuario = p_idUsuario;

    -- Eliminar el usuario
    DELETE FROM tbusuario WHERE idUsuario = p_idUsuario;

    -- Eliminar la dirección relacionada
    DELETE FROM tbdireccion WHERE idDireccion = @idDireccion;
    
    SET p_salida = 'Usuario eliminado exitosamente';
   ELSE
        -- Si ocurrió algún error de validación, hacer rollback
        ROLLBACK;
    END IF;

END$$
DELIMITER ;
----------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spLeerUsuario`()
BEGIN
    SELECT 
        u.idUsuario, 
        u.cedulaUsuario, 
        u.nombreUsuario, 
        u.primerApellido, 
        u.segundoApellido, 
        u.telefonoUsuario, 
        u.correoUsuario, 
        u.contraseniaUsuario, 
        u.fechaNacimiento,
        u.idDireccion,
        u.idRol, 
        d.idDistrito 
    FROM 
        tbusuario u
    INNER JOIN 
        tbdireccion d ON u.idDireccion = d.idDireccion;
END$$
DELIMITER ;

--------------------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spBuscarUsuarioPorCorreo`(
    IN correoInput VARCHAR(255)
)
BEGIN
    -- Selecciona todos los campos del usuario basándose en el correo proporcionado
    SELECT 
        u.idUsuario, 
        u.nombreUsuario, 
        u.primerApellido, 
        u.segundoApellido, 
        u.fechaNacimiento, 
        u.cedulaUsuario, 
        u.correoUsuario, 
        u.telefonoUsuario, 
        u.contraseniaUsuario,  -- Contraseña encriptada
        u.idRol,  -- ID del Rol del Usuario
        r.nombreRol,  -- Nombre del Rol
        r.descripcionRol, -- Descripción del Rol
        u.idDireccion  -- Asegúrate de incluir esto
    FROM 
        tbusuario u
    LEFT JOIN 
        tbrol r ON u.idRol = r.idRol
    WHERE 
        u.correoUsuario = correoInput;
END$$
DELIMITER ;

-----------------------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spVerificarCorreo`(IN p_correoUsuario VARCHAR(255))
BEGIN
    SELECT COUNT(*) AS existe FROM tbusuario WHERE correoUsuario = p_correoUsuario;
END$$
DELIMITER ;

-------------------------------------------------------------

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `spRegistrarUsuario`(
    IN `p_correoUsuario` VARCHAR(255), 
    IN `p_contraseniaUsuario` VARCHAR(255),
    IN `p_nombreUsuario` VARCHAR(255), -- Nuevo parámetro
    IN `p_primerApellido` VARCHAR(255), -- Nuevo parámetro
    IN `p_segundoApellido` VARCHAR(255), -- Nuevo parámetro
    OUT `p_salida` VARCHAR(255)
)
BEGIN
    -- Variable de control
    DECLARE done INT DEFAULT 0;

    -- Manejador de errores para capturar excepciones SQL genéricas
    DECLARE EXIT HANDLER FOR SQLEXCEPTION 
    BEGIN
        -- Si ocurre un error SQL, se hace rollback y se asigna un mensaje genérico
        ROLLBACK;
        SET p_salida = 'Error al agregar';
    END;

    -- Iniciar la transacción
    START TRANSACTION;

    -- Validar si el correo es nulo o vacío
    IF p_correoUsuario IS NULL OR p_correoUsuario = '' THEN
        SET p_salida = 'Correo vacío';
        SET done = 1; -- Detener flujo si hay error
    END IF;

    -- Validar si la contraseña es nula o vacía
    IF done = 0 AND (p_contraseniaUsuario IS NULL OR p_contraseniaUsuario = '') THEN
        SET p_salida = 'Contraseña vacía';
        SET done = 1; -- Detener flujo si hay error
    END IF;

    -- Validar si el nombreUsuario es nulo o vacío
    IF done = 0 AND (p_nombreUsuario IS NULL OR p_nombreUsuario = '') THEN
        SET p_salida = 'Nombre de usuario vacío';
        SET done = 1; -- Detener flujo si hay error
    END IF;

    -- Validar si el primerApellido es nulo o vacío
    IF done = 0 AND (p_primerApellido IS NULL OR p_primerApellido = '') THEN
        SET p_salida = 'Primer apellido vacío';
        SET done = 1; -- Detener flujo si hay error
    END IF;

    -- Validar si el segundoApellido es nulo o vacío
    IF done = 0 AND (p_segundoApellido IS NULL OR p_segundoApellido = '') THEN
        SET p_salida = 'Segundo apellido vacío';
        SET done = 1; -- Detener flujo si hay error
    END IF;

    -- Validar que el correo sea único
    IF done = 0 AND EXISTS (SELECT 1 FROM tbusuario WHERE correoUsuario = p_correoUsuario) THEN
        SET p_salida = 'El correo ya está registrado';
        SET done = 1; -- Detener flujo si hay error
    END IF;

    -- Solo proceder si no hay errores previos
    IF done = 0 THEN
        -- Insertar la dirección
        INSERT INTO tbdireccion ()
        VALUES ();

        -- Obtener el ID de la dirección insertada
        SET @idDireccion = LAST_INSERT_ID();

        -- Insertar el usuario con los nuevos campos
        INSERT INTO tbusuario (correoUsuario, contraseniaUsuario, nombreUsuario, primerApellido, segundoApellido, idDireccion, idRol)
        VALUES (p_correoUsuario, p_contraseniaUsuario, p_nombreUsuario, p_primerApellido, p_segundoApellido, @idDireccion, 3); -- 3 es el ID del rol, según tu ejemplo

        -- Si todo va bien, hacer commit
        COMMIT;
        SET p_salida = 'Usuario agregado exitosamente';
    ELSE
        -- Si ocurrió algún error de validación, hacer rollback
        ROLLBACK;
    END IF;

END$$
DELIMITER ;