CREATE DEFINER=`root`@`localhost` PROCEDURE `spAgregarCarrito`(
    IN `p_idUsuario` INT, 
    IN `p_montoTotalCarrito` DECIMAL(38,2), 
    IN `p_estadoCarrito` TINYINT(1),
    IN `p_cantidadCarrito` INT
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION 
    BEGIN
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Error en la inserción del carrito';
    END;

    START TRANSACTION;

    -- Validaciones mejoradas
    IF p_idUsuario IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ID de usuario es requerido';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM tbusuario WHERE idUsuario = p_idUsuario) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Usuario no existe';
    END IF;

    IF p_montoTotalCarrito IS NULL OR p_montoTotalCarrito <= 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Monto total debe ser mayor a cero';
    END IF;

    IF p_cantidadCarrito IS NULL OR p_cantidadCarrito <= 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cantidad debe ser positiva';
    END IF;

    -- INSERT corregido (eliminé p_montoPrecioProducto que no es parámetro)
    INSERT INTO tbcarrito (
        idUsuario, 
        montoTotalCarrito, 
        cantidadCarrito, 
        estadoCarrito
    )
    VALUES (
        p_idUsuario, 
        p_montoTotalCarrito, 
        p_cantidadCarrito, 
        p_estadoCarrito
    );

    COMMIT;
END